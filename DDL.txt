-- Создание базы данных
CREATE DATABASE Cinema;
\c Cinema;

-- Создание таблицы кинотеатров
CREATE TABLE halls (
    id SERIAL PRIMARY KEY,
    number_rows INT NOT NULL,
    number_seats INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Создание таблицы фильмов
CREATE TABLE films (
    id SERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    duration INT NOT NULL,
    rating NUMERIC(3, 1),  -- 3 знака всего, 1 знак после запятой
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Индексы для таблицы films
CREATE INDEX idx_films_title ON films(title);
CREATE INDEX idx_films_rating ON films(rating);

-- Создание таблицы атрибутов
CREATE TABLE attributes (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    attribute_type_id INT NOT NULL,
    FOREIGN KEY (attribute_type_id) REFERENCES attribute_types(id) ON DELETE CASCADE
);

-- Индекс для таблицы attributes
CREATE INDEX idx_attributes_name ON attributes(name);

-- Создание таблицы типов атрибутов
CREATE TABLE attribute_types (
    id SERIAL PRIMARY KEY,
    type_name VARCHAR(50) NOT NULL
);

-- Создание таблицы значений атрибутов
CREATE TABLE attribute_values (
    id SERIAL PRIMARY KEY,
    film_id INT NOT NULL,
    attribute_id INT NOT NULL,
    value_text TEXT,
    value_date DATE,
    value_image VARCHAR(255),
    FOREIGN KEY (film_id) REFERENCES films(id) ON DELETE CASCADE,
    FOREIGN KEY (attribute_id) REFERENCES attributes(id) ON DELETE CASCADE
);

-- Индексы для таблицы attribute_values
CREATE INDEX idx_attribute_values_film_id ON attribute_values(film_id);
CREATE INDEX idx_attribute_values_attribute_id ON attribute_values(attribute_id);

-- Создание таблицы рецензий
CREATE TABLE reviews (
    id SERIAL PRIMARY KEY,
    film_id INT,
    grade INT NOT NULL,
    text TEXT,
    FOREIGN KEY (film_id) REFERENCES films(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Индекс для таблицы reviews
CREATE INDEX idx_reviews_film_id ON reviews(film_id);

-- Создание таблицы сеансов
CREATE TABLE sessions (
    id SERIAL PRIMARY KEY,
    hall_id INT,
    film_id INT,
    start_time TIMESTAMP NOT NULL,
    price NUMERIC(10, 2) NOT NULL,  -- Точно для цен
    FOREIGN KEY (hall_id) REFERENCES halls(id) ON DELETE CASCADE,
    FOREIGN KEY (film_id) REFERENCES films(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Индексы для таблицы sessions
CREATE INDEX idx_sessions_hall_id ON sessions(hall_id);
CREATE INDEX idx_sessions_film_id ON sessions(film_id);

-- Создание таблицы билетов
CREATE TABLE tickets (
    id SERIAL PRIMARY KEY,
    session_id INT,
    row_number INT NOT NULL,
    seat_number INT NOT NULL,
    price NUMERIC(10, 2) NOT NULL,  -- Точно для цен
    customer_name VARCHAR(255),
    customer_email VARCHAR(255),
    customer_phone VARCHAR(255),
    FOREIGN KEY (session_id) REFERENCES sessions(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Индекс для таблицы tickets
CREATE INDEX idx_tickets_session_id ON tickets(session_id);
