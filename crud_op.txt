// Создать индекс (базу)

PUT http://localhost:9200/my_index


// Создать документ

POST http://localhost:9200/my_index/_doc

Запрос

{"title":"Вино белое Дартаньян","sku":"500-000","category":"Вино","price":3257,"volume":1,"stock":[{"shop":"Мира","stock":16},{"shop":"Ленина","stock":5}]}

Ответ 

{
    "_index": "my_index",
    "_id": "uNAy3JUBygY7KxeazJhR",
    "_version": 1,
    "result": "created",
    "_shards": {
        "total": 2,
        "successful": 1,
        "failed": 0
    },
    "_seq_no": 0,
    "_primary_term": 1
}

// Создать документ с id 500-001

Запрос

POST http://localhost:9200/my_index/_create/500-001

{"title":"Вино белое Новое","sku":"500-001","category":"Вино","price":3257,"volume":1,"stock":[{"shop":"Мира","stock":16},{"shop":"Ленина","stock":5}]}

Ответ 

{
    "_index": "my_index",
    "_id": "500-001",
    "_version": 1,
    "result": "created",
    "_shards": {
        "total": 2,
        "successful": 1,
        "failed": 0
    },
    "_seq_no": 1,
    "_primary_term": 1
}



Поиск

GET http://localhost:9200/my_index/_search

{"query": { "match_all" : {}}}









# Другие SQL-решения

## Подготовка к занятию

```bash
docker pull docker.elastic.co/elasticsearch/elasticsearch:8.12.2

docker run --name otus-elasticsearch -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" -it -m 4GB docker.elastic.co/elasticsearch/elasticsearch:8.12.2
```

```
✅ Elasticsearch security features have been automatically configured!
✅ Authentication is enabled and cluster connections are encrypted.

ℹ️  Password for the elastic user (reset with `bin/elasticsearch-reset-password -u elastic`):
  42Y2ZFZUqGytkzsXA2vb

ℹ️  HTTP CA certificate SHA-256 fingerprint:
  317c551ba9f0984f6a3cf50f642ce024a5b0f61dc2d10b8df9dfc3149ca89c7d

ℹ️  Configure Kibana to use this cluster:
• Run Kibana and click the configuration link in the terminal when Kibana starts.
• Copy the following enrollment token and paste it into Kibana in your browser (valid for the next 30 minutes):
  eyJ2ZXIiOiI4LjEyLjIiLCJhZHIiOlsiMTcyLjE3LjAuMjo5MjAwIl0sImZnciI6IjMxN2M1NTFiYTlmMDk4NGY2YTNjZjUwZjY0MmNlMDI0YTViMGY2MWRjMmQxMGI4ZGY5ZGZjMzE0OWNhODljN2QiLCJrZXkiOiI5aVJTVW80Ql9jb2tGYnIwdFpqTTpoZkJ3TnZkVVNGT2ZnLW1lYm9fV0RRIn0=

ℹ️ Configure other nodes to join this cluster:
• Copy the following enrollment token and start new Elasticsearch nodes with `bin/elasticsearch --enrollment-token <token>` (valid for the next 30 minutes):
  eyJ2ZXIiOiI4LjEyLjIiLCJhZHIiOlsiMTcyLjE3LjAuMjo5MjAwIl0sImZnciI6IjMxN2M1NTFiYTlmMDk4NGY2YTNjZjUwZjY0MmNlMDI0YTViMGY2MWRjMmQxMGI4ZGY5ZGZjMzE0OWNhODljN2QiLCJrZXkiOiItQ1JTVW80Ql9jb2tGYnIwdFpqZTpUd2dzTzhwUFN4T2s2dmhOdTd2elJ3In0=

  If you're running in Docker, copy the enrollment token and run:
  `docker run -e "ENROLLMENT_TOKEN=<token>" docker.elastic.co/elasticsearch/elasticsearch:8.12.2`
```
## Elasticsearch

### CRUD-операции

```json
{
    "title": "Агдам",
    "sku": "342-001",
    "category": "Портвейн",
    "price": 150,
    "volume": 0.7,
    "stock": [
        {
            "shop": "Мира",
            "stock": 30
        },
        {
            "shop": "Ленина",
            "stock": 0
        }
    ]
}
```

```json
{
    "title": "Красное вино Шардонель",
    "sku": "342-002",
    "category": "Вино",
    "price": 399,
    "volume": 0.5,
    "stock": [
        {
            "shop": "Мира",
            "stock": 10
        },
        {
            "shop": "Ленина",
            "stock": 5
        }
    ]
}
```

```json
{
    "title": "Белое вино Маркизель",
    "sku": "342-003",
    "category": "Вино",
    "price": 280,
    "volume": 0.5,
    "stock": [
        {
            "shop": "Мира",
            "stock": 0
        },
        {
            "shop": "Ленина",
            "stock": 0
        }
    ]
}
```

```json
{
    "title": "Вино красное Шатобриель",
    "sku": "342-004",
    "category": "Вино",
    "price": 1200,
    "volume": 0.7,
    "stock": [
        {
            "shop": "Мира",
            "stock": 0
        },
        {
            "shop": "Ленина",
            "stock": 1
        }
    ]
}
```

```json
{
    "doc": {
        "price": 2500
    }
}
```

### Массовое добавление документов

```bash
curl \
  --location \
  --insecure \
  --request POST 'https://localhost:9200/_bulk' \
  --header 'Authorization: Basic ZWxhc3RpYzpldXJZYnFPRGw9TURNYmpNNk8xUA==' \
  --header 'Content-Type: application/json' \
  --data-binary "@bulk.json"
```

### Поиск

```json
{
    "query": {
        "match_all": {}
    }
}
```

```json
{
    "query": {
        "match": {
            "title": "красное вино"
        }
    }
}
```

```json
{
    "query": {
        "term": {
            "category": "Портвейн"
        }
    }
}
```

```json
{
    "query": {
        "term": {
            "category.keyword": "Портвейн"
        }
    }
}
```

```json
{
    "query": {
        "range": {
            "price": {
                "gte": 1200,
                "lt": 1300
            }
        }
    }
}
```

```json
{
    "query": {
        "bool": {
            "must": [
                {
                    "match": {
                        "title": "красное"
                    }
                }
            ],
            "filter": [
                {
                    "range": {
                        "price": {
                            "gte": 9950
                        }
                    }
                }
            ]
        }
    }
}
```

```json
{
    "query": {
        "bool": {
            "must": [
                {
                    "match": {
                        "title": "красное"
                    }
                }
            ],
            "filter": [
                {
                    "range": {
                        "price": {
                            "gte": 9950
                        }
                    }
                }
            ],
            "should": [
                {
                    "range": {
                        "volume": {
                            "gt": 0.99
                        }
                    }
                }
            ]
        }
    }
}
```

### Оптимизация индексов

```json
{
    "query": {
        "match_all": {}
    },
    "size": 0,
    "aggs": {
        "min_volume": {
            "min": {
                "field": "volume"
            }
        }
    }
}
```

```json
{
    "size": 0,
    "aggs": {
        "volumes": {
            "terms": {
                "field": "volume",
                "size": 10
            }
        }
    }
}
```

```json
{
    "mappings": {
        "properties": {
            "category": {
                "type": "keyword"
            },
            "price": {
                "type": "integer"
            },
            "sku": {
                "type": "keyword"
            },
            "stock": {
                "properties": {
                    "shop": {
                        "type": "keyword"
                    },
                    "stock": {
                        "type": "integer"
                    }
                }
            },
            "title": {
                "type": "text",
                "fields": {
                    "keyword": {
                        "type": "keyword",
                        "ignore_above": 256
                    }
                }
            },
            "volume": {
                "type": "float"
            }
        }
    }
}
```

### Поиск по вложенным массивам

```json
{
    "query": {
        "bool": {
            "filter": [
                {
                    "match": {
                        "stock.shop": "Мира"
                    }
                },
                {
                    "range": {
                        "stock.stock": {
                            "gte": 15
                        }
                    }
                }
            ]
        }
    }
}
```

```json
{
    "mappings": {
        "properties": {
            "category": {
                "type": "keyword"
            },
            "price": {
                "type": "integer"
            },
            "sku": {
                "type": "keyword"
            },
            "stock": {
                "type": "nested",
                "properties": {
                    "shop": {
                        "type": "keyword"
                    },
                    "stock": {
                        "type": "integer"
                    }
                }
            },
            "title": {
                "type": "text",
                "fields": {
                    "keyword": {
                        "type": "keyword",
                        "ignore_above": 256
                    }
                }
            },
            "volume": {
                "type": "float"
            }
        }
    }
}
```

```json
{
    "query": {
        "nested": {
            "path": "stock",
            "query": {
                "bool": {
                    "filter": [
                        {
                            "match": {
                                "stock.shop": "Мира"
                            }
                        },
                        {
                            "range": {
                                "stock.stock": {
                                    "gte": 15
                                }
                            }
                        }
                    ]
                }
            }
        }
    }
}
```

### Полнотекстовый поиск

```json
{
    "content": "Для создания ООО вам необохдимо пройти процедуру государственной регистрации в регистрирующем органе ФНС по месту юридического адреса."
}
```

```json
{
    "content": "Вы можете получить ответы на вопросы о регистрации ООО и ИП, воспользовавшись услугой бесплатной консультации по регистрации бизнеса."
}
```

```json
{
    "query": {
        "match": {
            "content": "ООО"
        }
    }
}
```

```json
{
    "query": {
        "match": {
            "content": "ИП"
        }
    }
}
```

```json
{
    "query": {
        "match": {
            "content": "консультация"
        }
    }
}
```

### Поддержка морфологии русского языка

```json
{
    "settings": {
        "analysis": {
            "filter": {
                "ru_stop": {
                    "type": "stop",
                    "stopwords": "_russian_"
                },
                "ru_stemmer": {
                    "type": "stemmer",
                    "language": "russian"
                }
            },
            "analyzer": {
                "my_russian": {
                    "tokenizer": "standard",
                    "filter": [
                        "lowercase",
                        "ru_stop",
                        "ru_stemmer"
                    ]
                }
            }
        }
    },
    "mappings": {
        "properties": {
            "content": {
                "type": "text",
                "analyzer": "my_russian"
            }
        }
    }
}
```

```json
{
    "content": "Для создания ООО вам необохдимо пройти процедуру государственной регистрации в регистрирующем органе ФНС по месту юридического адреса."
}
```

```json
{
    "content": "Вы можете получить ответы на вопросы о регистрации ООО и ИП, воспользовавшись услугой бесплатной консультации по регистрации бизнеса."
}
```

```json
{
    "query": {
        "match": {
            "content": "консультация"
        }
    }
}
```

### Работа с опечатками

```json
{
    "query": {
        "match": {
            "content": "кансультация"
        }
    }
}
```

```json
{
    "query": {
        "match": {
            "content": {
                "query": "кансультация",
                "fuzziness": "auto"
            }
        }
    }
}
```

## Ссылка на опрос

```
https://otus.ru/polls/117235/
```