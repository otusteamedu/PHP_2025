#!/usr/bin/php
<?php declare(strict_types=1);

require 'vendor/autoload.php';

use Elastic\Elasticsearch\ClientBuilder;
use LucidFrame\Console\ConsoleTable;

// Парсим аргументы командной строки
$options = getopt('q:c:p:m:h', ['query:', 'category:', 'price:', 'min-stock:', 'help']);

if (isset($options['h']) || isset($options['help'])) {
	showHelp();
	exit(0);
}

$query = $options['q'] ?? $options['query'] ?? null;
$category = $options['c'] ?? $options['category'] ?? null;
$maxPrice = $options['p'] ?? $options['price'] ?? null;
$minStock = $options['m'] ?? $options['min-stock'] ?? 1;

if (!$query) {
	echo "Ошибка: Не указан поисковый запрос\n";
	showHelp();
	exit(1);
}

// Подключаемся к Elasticsearch
$client = ClientBuilder::create()
	->setHosts(['http://elasticsearch:9200'])
    ->build();

// Строим запрос
$searchParams = [
	'index' => 'otus-shop',
	'body' => [
		'query' => [
			'bool' => [
				'must' => [
					[
						'multi_match' => [
							'query' => $query,
							'fields' => ['title', 'category'],
							'fuzziness' => 'AUTO'
						]
					]
				],
				'filter' => []
			]
		]
	]
];

// Добавляем фильтры
if ($category) {
	$searchParams['body']['query']['bool']['filter'][] = [
		'term' => ['category' => $category]
	];
}

if ($maxPrice) {
	$searchParams['body']['query']['bool']['filter'][] = [
		'range' => ['price' => ['lte' => (int)$maxPrice]]
	];
}

if ($minStock) {
	$searchParams['body']['query']['bool']['filter'][] = [
		'nested' => [
			'path' => 'stock',
			'query' => [
				'range' => ['stock.stock' => ['gte' => (int)$minStock]]
			]
		]
	];
}

// Выполняем поиск
try {
	$response = $client->search($searchParams);
	displayResults($response);
} catch (Exception $e) {
	echo "Ошибка поиска: ", $e->getMessage(), "\n";
	exit(1);
}

function displayResults($response) {
	$table = new LucidFrame\Console\ConsoleTable();

	$hits = $response['hits']['hits'];
	$total = $response['hits']['total']['value'];

	if ($total === 0) {
		echo "Ничего не найдено\n";
		return;
	}

	// Задаем заголовок таблицы
	$table->setHeaders(["Название", "Категория", "Цена", "В наличии"]);

	foreach ($hits as $hit) {
		$source = $hit['_source'];
		$totalStock = array_sum(array_column($source['stock'], 'stock'));

		$table->addRow([
            $source['title'],
			$source['category'],
			$source['price'],
			$totalStock
        ]);
	}

    $table
		->addFooter('Найдено товаров:')
		->addFooter($total, ConsoleTable::ALIGN_RIGHT)
        ->display();
}

function showHelp() {
	echo "Использование: php src/console [опции]\n";
	echo "Опции:\n";
	echo "  -q, --query=STRING     Поисковый запрос (обязательный)\n";
	echo "  -c, --category=STRING  Фильтр по категории\n";
	echo "  -p, --price=NUMBER     Максимальная цена\n";
	echo "  -m, --min-stock=NUMBER Минимальное количество на складе (по умолчанию 1)\n";
	echo "  -h, --help             Показать эту справку\n";
}