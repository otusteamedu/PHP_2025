# PHP_2025

https://otus.ru/lessons/razrabotchik-php/?utm_source=github&utm_medium=free&utm_campaign=otus

## Описание задания в Task_description
# Тест-кейсы для системы оплаты просмотра фильма

## 1. Модульные тесты (Unit Tests)

Тестируем контроллер оплаты изолированно, с моками зависимостей (сервиса A и репозитория).

### 1.1 Валидация входных данных

a. **Номер карты**:
   - Если card_number содержит не 16 цифр → возвращаем 400 с сообщением "Номер карты должен содержать 16 цифр"
   - Если card_number содержит буквы или символы → 400 с сообщением "Номер карты должен содержать только цифры"

b. **Владелец карты**:
   - Если card_holder содержит более одного пробела → 400 с сообщением "Некорректное имя владельца карты"
   - Если card_holder содержит нелатинские буквы → 400 с сообщением "Имя владельца должно содержать только латинские буквы"
   - Если card_holder содержит цифры → 400 с сообщением "Имя владельца не должно содержать цифр"

c. **Срок действия**:
   - Если card_expiration не в формате мм/гг → 400 с сообщением "Некорректный формат срока действия"
   - Если месяц больше 12 → 400 с сообщением "Некорректный месяц"
   - Если срок действия истёк → 400 с сообщением "Срок действия карты истёк"

d. **CVV**:
   - Если cvv не 3 цифры → 400 с сообщением "CVV должен содержать 3 цифры"
   - Если cvv содержит буквы → 400 с сообщением "CVV должен содержать только цифры"

e. **Сумма**:
   - Если sum не число с запятой в качестве разделителя → 400 с сообщением "Некорректный формат суммы"
   - Если sum отрицательная → 400 с сообщением "Сумма должна быть положительной"

f. **Корректные данные**:
   - При валидном card_number (ровно 16 цифр) → валидация проходит успешно
   - При валидном card_holder (имя и фамилия латиницей, один пробел или дефис) → валидация проходит успешно
   - При валидном card_expiration (формат мм/гг, месяц 01-12, срок не истёк) → валидация проходит успешно
   - При валидном cvv (ровно 3 цифры) → валидация проходит успешно
   - При валидном sum (положительное число с запятой) → валидация проходит успешно
   
### 1.2 Взаимодействие с сервисом A

a. При успешной валидации:
   - Сервис A получает корректные платежные данные
   - При ответе 200 от сервиса A → возвращается успешный ответ
   
b. Если сервис A возвращает 403 → возвращаем 403 с сообщением "Не удалось списать средства"
c. Если сервис A недоступен → возвращаем 500 с сообщением "Ошибка обработки платежа"

### 1.3 Взаимодействие с репозиторием

a. При успешном ответе от сервиса A → вызывается setOrderIsPaid с правильными параметрами
b. Если setOrderIsPaid возвращает false → возвращаем 500 с сообщением "Ошибка подтверждения платежа"
c. Если setOrderIsPaid выбрасывает исключение → возвращаем 500 с сообщением "Ошибка подтверждения платежа"

## 2. Интеграционные тесты (Integration Tests)

### 2.1 Связка "фронт-бэк"

a. При ошибке в card_number:
   - Фронт получает ответ 400 с сообщением об ошибке
   - Поле "Номер карты" выделяется красной рамкой
   - Отображается сообщение об ошибке под полем

b. При успешной оплате:
   - Фронт получает ответ 200 с данными об успешной оплате
   - Отображается сообщение об успешной оплате
   - Кнопка "Оплатить" становится неактивной

### 2.2 Связка "бэк-сервис A"

a. При корректных данных:
   - Бэк отправляет правильный запрос в сервис A
   - Ответ сервиса A корректно обрабатывается бэком

b. При ошибке сервиса A:
   - Бэк корректно обрабатывает ответ 403
   - Возвращает соответствующее сообщение фронту

### 2.3 Связка "бэк-репозиторий"

a. При успешной оплате:
   - Вызывается setOrderIsPaid с правильными параметрами
   - Ответ репозитория корректно обрабатывается

b. При ошибке репозитория:
   - Исключения репозитория корректно обрабатываются
   - Возвращается соответствующий HTTP-статус

## 3. Системные тесты (System Tests)

### 3.1 Полный сценарий успешной оплаты

a. Пользователь вводит корректные данные:
   - Фронт отправляет данные на бэк
   - Бэк валидирует данные и отправляет в сервис A
   - Сервис A подтверждает оплату
   - Бэк сохраняет данные в репозиторий
   - Фронт отображает сообщение об успешной оплате
   - Пользователь получает доступ к фильму

### 3.2 Ошибка при оплате

a. Пользователь вводит неверный CVV:
   - Сервис A возвращает 403
   - Бэк передаёт ошибку фронту
   - Фронт выделяет поле CVV красным и показывает сообщение "Не удалось списать данные с карты, проверьте реквизиты"
   - Пользователь может исправить данные и повторить попытку

### 3.3 Ошибка при сохранении данных

a. После успешного списания возникает ошибка базы данных:
   - Бэк возвращает 500
   - Фронт показывает сообщение "Ошибка подтверждения платежа, обратитесь в поддержку"
   - Система отправляет уведомление администратору
   - Деньги не списываются с карты пользователя (откат транзакции)

## Рекомендации по удешевлению тестирования

1. Для тестирования взаимодействия с сервисом A использовать sandbox-окружение с тестовыми картами
2. Для интеграционных тестов с сервисом A использовать mock-сервер, имитирующий его поведение
3. Для тестирования сценариев ошибок БД использовать специально настроенное тестовое окружение с возможностью искусственного вызова ошибок
4. Системные тесты с реальными платежами проводить только для критических сценариев и на минимальных суммах
5. Реализовать feature-флаги для отключения реальных платежей в тестовом окружении
