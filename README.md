# ДЗ №19 - Очереди. Часть 2

## Описание задачи

Пишем приложение обработки отложенных запросов.

1. Создать простое веб-приложение, принимающее POST запрос из формы от пользователя. Например, запрос на генерацию
   банковской выписки за указанные даты.
    - Обычно такие запросы (в реальных системах) работают довольно долго, поэтому пользователя надо оповестить о том,
      что запрос принят в обработку
    - Форма должна подразумевать отправку оповещения по результатам работы

2. Передать тело запроса в очередь

3. Написать скрипт, который будет читать сообщения из очереди и выводить информацию о них в консоль

4. Реализация оповещения
    - Сгенерированный ответ отправить через email или telegram

## Реализация

### Архитектура

- Контейнер `otus_nginx` - веб сервер
- Контейнер `otus_php_fpm` - приложение
- Контейнер `otus_rabbit_mq` - сервер очередей
- Контейнер `otus_websocket` - сервер Websocket
- Контейнер `otus_worker` - сервер StatementWorker

`otus_php_fpm` <-> unix:socket <-> `otus_nginx`

`otus_websocket` <-> :8080 <-> `otus_nginx`

`otus_worker` <-> :5672 <-> `otus_rabbit_mq`

`otus_websocket` <-> :5672 <-> `otus_rabbit_mq`

### Порты

| Порт  | Назначение              |
|-------|-------------------------|
| 80    | Приложение              |
| 8080  | Websocket сервер        |
| 15672 | Web-оболочка RabbitMQ   |
| 5672  | порт для протокола AMQP |

## Настройка

1. Переименовать `.env.example` в `.env`
2. Скорректировать переменные:

| Переменная        | Назначение                                           |
|-------------------|------------------------------------------------------|
| RMQ_HOST          | Хост RabbitMQ                                        |
| RMQ_PORT          | Порт RabbitMQ                                        |
| RMQ_USER          | Пользователь RabbitMQ                                |
| RMQ_PASSWORD      | Пароль RabbitMQ                                      |
| RMQ_QUEUE_NAME    | Имя очереди                                          |
| RMQ_EXCHANGE_NAME | Имя обменника                                        |
| SMTP_HOST         | Хость SMTP сервера                                   |
| SMTP_USERNAME     | Пользователь SMTP сервера                            |
| SMTP_PASSWORD     | Пароль SMTP сервера                                  |
| SMTP_PORT         | Порт SMTP сервера                                    |
| SMTP_SECURE       | Тип безопасности SMTP сервера                        |
| EMAIL_FROM        | Адрес откуда приходит e-mail                         |
| TG_BOT_TOKEN      | Токен бота Telegram (false - отправка в TG не будет) |

## Запуск

1. Запускаем контейнеры

```shell
docker-compose -f docker-compose.yml up -d
```

2. Дожидаемся загрузки конейнера `otus_rabbit_mq` (пока не запуститься контейнер, websocket и worker не запустятся)
3. Открываем приложение [http://localhost](http://localhost)
4. Вводим E-mail, выбираем даты формирования выписки, ожидаем завершения.