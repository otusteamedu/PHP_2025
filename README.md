# PHP_2025

https://otus.ru/lessons/razrabotchik-php/?utm_source=github&utm_medium=free&utm_campaign=otus

# Описание

Подготовить список из 6 основных запросов к БД, разработанной на предыдущих занятиях


1. Выбор всех фильмов на сегодня

2. Подсчёт проданных билетов за неделю

3. Формирование афиши (фильмы, которые показывают сегодня)

4. Поиск 3 самых прибыльных фильмов за неделю

5. Сформировать схему зала и показать на ней свободные и занятые места на конкретный сеанс

6. Вывести диапазон миниальной и максимальной цены за билет на конкретный сеанс


Целесообразно выбрать 3 "простых" (задействована 1 таблица), 3 "сложных" (агрегатные функции, связи таблиц).


Далее нужно заполнить таблицы, увеличив общее количество строк текстовых данных до 10000.

Затем проведите анализ производительности запросов к БД, сохранить планы выполнения.


Заполните таблицы, увеличив общее количество строк текстовых данных до 10000000.

Затем проведите анализ производительности запросов к БД, сохранить планы выполнения.


На основе анализа запросов и планов предложить оптимизации (индексы, структура, параметры и др.

Добавьте индексы и сравните результат, приложив планы выполнения.


Результат:

    скрипт создания БД (с предыдущих занятий)
    скрипт заполнения БД тестовыми данными
    таблица с результатами по каждому из 6 запросов
        запрос
        план на БД до 10000 строк
        план на БД до 10000000 строк
        план на БД до 10000000 строк, что удалось улучшить
        перечень оптимизаций с пояснениями
    отсортированный список (15 значений) самых больших по размеру объектов БД (таблицы, включая индексы, сами индексы)
    отсортированные списки (по 5 значений) самых часто и редко используемых индексов


# Представление

Логическая модель для системы управления кинотеатром - PlantUML.png.
PlantUML сгенерирован с помощью бесплатного ресурса - https://www.plantuml.com/plantuml


# Использование

1. Разворот локальной базы данных

```docker run --name my-postgres -e POSTGRES_PASSWORD=mysecretpassword -d -p 5432:5432 postgres```
    
2. Скопируйте scripts с хоста в контейнер:

```docker cp scripts my-postgres:/scripts```

3. Подключение к контейнеру:

```docker exec -it my-postgres bash```

4. Подключение к PostgreSQL:

```psql -U postgres```

5. Создание базы данных:

```CREATE DATABASE cinema_db;```

6. Выход из postgres:

```\q```

7. Выполнение DDL-скрипта:

```psql -U postgres -d cinema_db -f /scripts/ddl.sql```

8. Выполнение DML-скрипта с тестовыми данными:

```psql -U postgres -d cinema_db -f /scripts/dml.sql```

9. Все SQL можно выполнить одновременно вместе с анализом:

```php analyze_queries.php > plans/plans_1test.txt```

10. Далее нужно заполнить бд до 10000 строк. Проверьте значение в .env. После запустите PHP-скрипт:

```GENERATE_ROWS=10000 ```

```php analyze_queries.php > plans/plans_10K.txt```

11. Далее нужно заполнить бд до 10000000 строк. Проверьте значение в .env. После запустите PHP-скрипт:

```GENERATE_ROWS=10000000 ```

```php analyze_queries.php > plans/plans_10M.txt```


Все планы хранятся в scripts/plans.

P.S. Подключение к базе данных cinema_db:

```psql -h localhost -p 5432 -U postgres -d cinema_db```

