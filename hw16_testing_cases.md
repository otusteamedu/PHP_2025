# Кейсы тестирования системы оплаты фильмов

## Описание системы
Система состоит из 4 модулей:
- **Фронт** - пользовательский интерфейс
- **Бэк** - контроллер обработки платежей
- **Репозиторий** - работа с базой данных
- **Сервис A** - внешний платежный сервис

## 1. Модульные тесты (Unit Tests)

### 1.1 Валидация card_number
- Если card_number содержит менее 16 цифр, то тестируемый метод возвращает 400 с сообщением "Номер карты должен содержать 16 цифр";
- Если card_number содержит более 16 цифр, то тестируемый метод возвращает 400 с сообщением "Номер карты должен содержать 16 цифр";
- Если card_number содержит нецифровые символы, то тестируемый метод возвращает 400 с сообщением "Номер карты должен содержать только цифры";
- Если card_number пустой, то тестируемый метод возвращает 400 с сообщением "Номер карты обязателен";

### 1.2 Валидация card_holder
- Если card_holder содержит более одного пробела подряд, то тестируемый метод возвращает 400 с сообщением "Имя владельца карты содержит некорректные пробелы";
- Если card_holder содержит цифры, то тестируемый метод возвращает 400 с сообщением "Имя владельца карты должно содержать только буквы и дефис";
- Если card_holder содержит специальные символы (кроме дефиса), то тестируемый метод возвращает 400 с сообщением "Имя владельца карты содержит недопустимые символы";
- Если card_holder пустой, то тестируемый метод возвращает 400 с сообщением "Имя владельца карты обязательно";
- Если card_holder содержит только одну букву, то тестируемый метод возвращает 400 с сообщением "Имя владельца карты должно содержать имя и фамилию";

### 1.3 Валидация card_expiration
- Если card_expiration имеет формат не мм/гг, то тестируемый метод возвращает 400 с сообщением "Неверный формат даты окончания действия карты";
- Если месяц больше 12, то тестируемый метод возвращает 400 с сообщением "Неверный месяц в дате окончания действия карты";
- Если год меньше текущего, то тестируемый метод возвращает 400 с сообщением "Срок действия карты истек";
- Если card_expiration пустой, то тестируемый метод возвращает 400 с сообщением "Дата окончания действия карты обязательна";

### 1.4 Валидация cvv
- Если cvv содержит менее 3 цифр, то тестируемый метод возвращает 400 с сообщением "CVV должен содержать 3 цифры";
- Если cvv содержит более 3 цифр, то тестируемый метод возвращает 400 с сообщением "CVV должен содержать 3 цифры";
- Если cvv содержит нецифровые символы, то тестируемый метод возвращает 400 с сообщением "CVV должен содержать только цифры";
- Если cvv пустой, то тестируемый метод возвращает 400 с сообщением "CVV обязателен";

### 1.5 Валидация order_number
- Если order_number содержит более 16 символов, то тестируемый метод возвращает 400 с сообщением "Номер заказа не должен превышать 16 символов";
- Если order_number пустой, то тестируемый метод возвращает 400 с сообщением "Номер заказа обязателен";

### 1.6 Валидация sum
- Если sum содержит некорректный формат (не число с запятой), то тестируемый метод возвращает 400 с сообщением "Неверный формат суммы";
- Если sum меньше или равно 0, то тестируемый метод возвращает 400 с сообщением "Сумма должна быть больше нуля";
- Если sum пустая, то тестируемый метод возвращает 400 с сообщением "Сумма обязательна";

### 1.7 Позитивные тесты валидации
- Если все поля содержат корректные данные (card_number - 16 цифр, card_holder - корректное имя и фамилию, card_expiration - валидный формат мм/гг с неистекшим сроком, cvv - 3 цифры, order_number - от 1 до 16 символов, sum - число больше 0), то тестируемый метод возвращает 200 и продолжает обработку;

## 2. Интеграционные тесты (Integration Tests)

### 2.1 Связка "Фронт-Бэк"
- Если card_holder содержит более одного пробела, то после получения ответа от бэка на фронте выделяется поле "Имя владельца карты" красной рамкой и отображается сообщение об ошибке;
- Если card_number содержит нецифровые символы, то после получения ответа от бэка на фронте выделяется поле "Номер карты" красной рамкой и отображается сообщение об ошибке;
- Если card_expiration имеет неверный формат, то после получения ответа от бэка на фронте выделяется поле "Дата окончания действия" красной рамкой и отображается сообщение об ошибке;
- Если cvv содержит неверное количество цифр, то после получения ответа от бэка на фронте выделяется поле "CVV" красной рамкой и отображается сообщение об ошибке;
- Если все данные корректны, то фронт отправляет запрос на бэк и ожидает ответа;

### 2.2 Связка "Бэк-Сервис A"
- Если Сервис A возвращает HTTP-код 403, то бэк передает ошибку на фронт с сообщением "Не удалось списать средства с карты";
- Если Сервис A возвращает HTTP-код 200, то бэк продолжает обработку и вызывает репозиторий;
- Если Сервис A недоступен (таймаут), то бэк возвращает ошибку с кодом 500 и сообщением "Сервис оплаты временно недоступен";
- Если Сервис A возвращает неожиданный HTTP-код, то бэк возвращает ошибку с кодом 500 и сообщением "Ошибка сервиса оплаты";

### 2.3 Связка "Бэк-Репозиторий"
- Если setOrderIsPaid возвращает true, то бэк возвращает успешный ответ на фронт с кодом 200;
- Если setOrderIsPaid выбрасывает исключение OrderNotFoundException, то бэк возвращает ошибку с кодом 404 и сообщением "Заказ не найден";
- Если setOrderIsPaid выбрасывает исключение SumMismatchException, то бэк возвращает ошибку с кодом 400 и сообщением "Сумма заказа не соответствует указанной";
- Если setOrderIsPaid выбрасывает исключение DatabaseException, то бэк возвращает ошибку с кодом 500 и сообщением "Ошибка базы данных";

### 2.4 Связка "Фронт-Сервис A" (через бэк)
- При успешной оплате фронт получает подтверждение и отображает сообщение "Оплата прошла успешно";
- При ошибке оплаты фронт получает сообщение об ошибке и отображает его пользователю;

## 3. Системные тесты (System Tests)

### 3.1 Сценарий успешной оплаты
Пользователь вводит корректные данные карты, фронт отправляет их на бэк, бэк валидирует данные, отправляет запрос в Сервис A, получает код 200, вызывает репозиторий, получает true, возвращает успешный ответ на фронт, фронт отображает сообщение "Оплата прошла успешно";

### 3.2 Сценарий с неверными данными карты
- Если cvv неверен, то после получения ответа от бэка на фронте выводится сообщение об ошибке "Не удалось списать данные с карты, проверьте реквизиты";
- Если номер карты неверный, то после получения ответа от бэка на фронте выводится сообщение об ошибке "Не удалось списать данные с карты, проверьте реквизиты";
- Если срок действия карты истек, то после получения ответа от бэка на фронте выводится сообщение об ошибке "Не удалось списать данные с карты, проверьте реквизиты";

### 3.3 Сценарий с ошибками валидации
a. Если пользователь вводит некорректный формат данных, то фронт отображает соответствующие сообщения об ошибках без отправки запроса на бэк;
b. Если пользователь оставляет обязательные поля пустыми, то фронт отображает сообщения о необходимости заполнения полей;

### 3.4 Сценарий с ошибками сервисов
- Если Сервис A недоступен, то пользователь получает сообщение "Сервис оплаты временно недоступен, попробуйте позже";
- Если база данных недоступна, то пользователь получает сообщение "Временная ошибка системы, попробуйте позже";

### 3.5 Сценарий с несоответствием данных заказа
Если сумма заказа в базе данных не соответствует переданной сумме, то пользователь получает сообщение "Ошибка в данных заказа, обратитесь в службу поддержки";

## Способы удешевления тестирования:
1. **Тестовые карты из песочницы** - использование sandbox-режима платёжного сервиса A (отдельный тестовый API-эндпоинт; набор тестовых карт, имитирующих разные сценарии);
2. **Мокирование Сервиса A** - использование заглушек вместо реальных запросов к платежному сервису;
3. **Тестовая база данных** - использование отдельной тестовой БД с тестовыми данными;
4. **Фикстуры** - создание тестовых данных для различных сценариев;
